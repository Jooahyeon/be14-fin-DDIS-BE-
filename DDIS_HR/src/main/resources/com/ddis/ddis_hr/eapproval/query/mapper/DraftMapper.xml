<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ddis.ddis_hr.eapproval.query.mapper.DraftMapper">

    <!-- âœ… DTO ë§µí•‘ ì„¤ì • -->
    <resultMap id="DraftDetailResultMap" type="com.ddis.ddis_hr.eapproval.query.dto.DraftDetailResponseQueryDTO">
        <!-- ê¸°ë³¸ ì •ë³´ ë§¤í•‘ -->
        <id property="docId" column="doc_id" />
        <result property="docTitle" column="doc_title" />
        <result property="team" column="team" />
        <result property="position" column="position" />
        <result property="drafter" column="drafter" />
        <result property="date" column="date" />
        <result property="docContent" column="doc_content" />
        <result property="keepYear" column="keep_year" />
        <result property="rankId" column="drafterRankId" />
        <result property="rankName" column="drafterRankName" />
        <result property="role" column="documentBoxRole" />

        <!-- ğŸ—‚ï¸ ê²°ì¬ë¼ì¸ ë¦¬ìŠ¤íŠ¸ ë§¤í•‘ (1:N) -->
        <collection property="approvalLine" ofType="com.ddis.ddis_hr.eapproval.query.dto.ApprovalLineQueryDTO">
            <result property="id" column="approvalLine_id" />
            <result property="step" column="step"/>
            <result property="employeeId" column="employee_id"/>
            <result property="name" column="approvalLine_name" />
            <result property="team" column="approvalLine_team" />
            <result property="position" column="approvalLine_position" />
            <result property="status" column="approvalLine_status" />
            <result property="type" column="approvalLine_type" />
            <result property="submitDate" column="approvalLine_submitDate" />
            <result property="approveDate" column="approvalLine_approveDate" />
            <result property="comment" column="approvalLine_comment" />
        </collection>
    </resultMap>

    <!--  ì „ì²´ ê¸°ì•ˆ ìƒì„¸ ì •ë³´ + ê²°ì¬ë¼ì¸ + íŒŒì¼ ì¡°íšŒ + rank, document_box.role ì¶”ê°€ -->
    <select id="selectDraftDetail" resultMap="DraftDetailResultMap">
        SELECT
            dd.doc_id,
            dd.doc_title,                                 --  ë³¸ë¬¸ ì œëª©
            dd.doc_content AS doc_content,                --  ë³¸ë¬¸ ë‚´ìš©
            dd.preserve_period AS keep_year,              --  ë³´ì¡´ì—°í•œ
            dd.created_at AS date,                        --  ê¸°ì•ˆì¼
            e.employee_name AS drafter,                   --  ê¸°ì•ˆì ì´ë¦„
            t.team_name AS team,                          --  ê¸°ì•ˆì íŒ€
            p.position_name AS position,                  --  ê¸°ì•ˆì ì§ì±…
            r.rank_id AS drafterRankId,                   --  ê¸°ì•ˆì ì§ê¸‰ ID
            r.rank_name AS drafterRankName,               --  ê¸°ì•ˆì ì§ê¸‰ëª…
            db.role AS documentBoxRole,                   --  ë¬¸ì„œí•¨ ì—­í• 

            --  ê²°ì¬ë¼ì¸ ì •ë³´ (ì—¬ëŸ¬ ëª… ê°€ëŠ¥)
            al.approval_line_id AS approvalLine_id,
            al.step,
            al.employee_id,
            ae.employee_name AS approvalLine_name,
            at.team_name AS approvalLine_team,
            ap.position_name AS approvalLine_position,
            al.status AS approvalLine_status,
            al.type AS approvalLine_type,
            al.approved_at AS approvalLine_approveDate,
            al.opinion AS approvalLine_comment,
            dd.submitted_at AS approvalLine_submitDate,

            -- ì²¨ë¶€íŒŒì¼ (ë‹¤ì¤‘ íŒŒì¼ì„ ìœ„í•´ ë³„ë„ ì¿¼ë¦¬ë¡œ ë¶„ë¦¬ ê¶Œì¥)
            df.file_name AS file_name,
            df.file_size AS file_size,
            df.file_type AS file_type

        FROM draft_documents dd
                 LEFT JOIN employee e ON dd.employee_id = e.employee_id
                 LEFT JOIN team t ON e.team_id = t.team_id
                 LEFT JOIN position p ON e.position_id = p.position_id
                 LEFT JOIN rank r ON e.rank_id = r.rank_id
                 LEFT JOIN document_box db ON dd.employee_id = db.employee_id AND dd.doc_id = db.doc_id

                 LEFT JOIN approval_line al ON dd.doc_id = al.doc_id AND al.line_type = 'ACTUAL'
                 LEFT JOIN employee ae ON al.employee_id = ae.employee_id
                 LEFT JOIN team at ON ae.team_id = at.team_id
                 LEFT JOIN position ap ON ae.position_id = ap.position_id

                 LEFT JOIN document_attachment df ON dd.doc_id = df.doc_id

        WHERE dd.doc_id = #{docId}
    </select>

    <!-- ê²°ì¬ ì´ë ¥ ì‚­ì œ í›„ íšŒìˆ˜ ì²˜ë¦¬ -->
    <select id="countFirstApproverAction" parameterType="long" resultType="int">
        <!-- 1ì°¨ ê²°ì¬ì(step=2)ê°€ ì´ë¯¸ ê²°ì¬(status IS NOT NULL)í–ˆëŠ”ì§€ í™•ì¸ -->
        SELECT COUNT(*)
        FROM approval_line
        WHERE doc_id = #{docId}
        AND step   = 2
        AND status IS NOT NULL
    </select>

    <!-- document_boxì—ì„œ ê¸°ì•ˆì ì œì™¸í•œ ê²°ì¬ìÂ·í˜‘ì¡°ì ì—”íŠ¸ë¦¬ ì‚­ì œ ë° draft_documents ìƒíƒœ ë³€ê²½ -->
        <update id="updateDocumentStatusToRecalled" parameterType="long">
            UPDATE draft_documents
            SET doc_status = 'íšŒìˆ˜'
            WHERE doc_id = #{docId}
        </update>
</mapper>

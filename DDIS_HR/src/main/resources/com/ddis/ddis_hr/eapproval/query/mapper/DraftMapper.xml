<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.ddis.ddis_hr.eapproval.query.mapper.DraftMapper">

    <!-- ‚úÖ DTO ÎßµÌïë ÏÑ§Ï†ï -->
    <resultMap id="DraftDetailResultMap" type="com.ddis.ddis_hr.eapproval.query.dto.DraftDetailResponseQueryDTO">
        <!-- Í∏∞Î≥∏ Ï†ïÎ≥¥ Îß§Ìïë -->
        <id property="docId" column="doc_id" />
        <result property="docTitle" column="doc_title" />
        <result property="team" column="team" />
        <result property="position" column="position" />
        <result property="drafter" column="drafter" />
        <result property="date" column="date" />
        <result property="docContent" column="doc_content" />
        <result property="keepYear" column="keep_year" />
        <result property="rankId" column="drafterRankId" />
        <result property="rankName" column="drafterRankName" />
        <result property="role" column="documentBoxRole" />

        <!-- üóÇÔ∏è Í≤∞Ïû¨ÎùºÏù∏ Î¶¨Ïä§Ìä∏ Îß§Ìïë (1:N) -->
        <collection property="approvalLine" ofType="com.ddis.ddis_hr.eapproval.query.dto.ApprovalLineQueryDTO">
            <result property="id" column="approvalLine_id" />
            <result property="step" column="step"/>
            <result property="employeeId" column="employee_id"/>
            <result property="name" column="approvalLine_name" />
            <result property="team" column="approvalLine_team" />
            <result property="position" column="approvalLine_position" />
            <result property="status" column="approvalLine_status" />
            <result property="type" column="approvalLine_type" />
            <result property="submitDate" column="approvalLine_submitDate" />
            <result property="approveDate" column="approvalLine_approveDate" />
            <result property="comment" column="approvalLine_comment" />
        </collection>
    </resultMap>

    <!--  Ï†ÑÏ≤¥ Í∏∞Ïïà ÏÉÅÏÑ∏ Ï†ïÎ≥¥ + Í≤∞Ïû¨ÎùºÏù∏ + ÌååÏùº Ï°∞Ìöå + rank, document_box.role Ï∂îÍ∞Ä -->
    <!-- 1) Ï≤®Î∂ÄÌååÏùº Ïª¨Îüº(file_url, file_name, file_size, file_type)ÎèÑ Ìï®Íªò Ï°∞Ìöå -->
    <select id="selectDraftDetail" resultMap="DraftDetailResultMap">
        SELECT
            dd.doc_id,
            dd.doc_title,
            dd.doc_content        AS doc_content,
            dd.preserve_period    AS keep_year,
            dd.created_at         AS date,
          e.employee_name       AS drafter,
          t.team_name           AS team,
          p.position_name       AS position,
          r.rank_id AS drafterRankId,                   --  Í∏∞ÏïàÏûê ÏßÅÍ∏â ID
          r.rank_name AS drafterRankName,               --  Í∏∞ÏïàÏûê ÏßÅÍ∏âÎ™Ö
          db.role AS documentBoxRole,

          al.approval_line_id   AS approvalLine_id,
          al.step               AS step,
          al.employee_id        AS employee_id,
          ae.employee_name      AS approvalLine_name,
          at.team_name          AS approvalLine_team,
          ap.position_name      AS approvalLine_position,
          al.status             AS approvalLine_status,
          al.type               AS approvalLine_type,
          al.approved_at        AS approvalLine_approveDate,
          al.opinion            AS approvalLine_comment,
          dd.submitted_at       AS submitted_date,

          df.file_url           AS file_url,
          df.file_name          AS file_name,
          df.file_size          AS file_size,
          df.file_type          AS file_type

        FROM draft_documents dd
                 LEFT JOIN employee e ON dd.employee_id = e.employee_id
                 LEFT JOIN team t ON e.team_id = t.team_id
                 LEFT JOIN position p ON e.position_id = p.position_id
                 LEFT JOIN rank r ON e.rank_id = r.rank_id
                 LEFT JOIN document_box db ON dd.employee_id = db.employee_id AND dd.doc_id = db.doc_id

                 LEFT JOIN approval_line al ON dd.doc_id = al.doc_id AND al.line_type = 'ACTUAL'
                 LEFT JOIN employee ae ON al.employee_id = ae.employee_id
                 LEFT JOIN team at ON ae.team_id = at.team_id
                 LEFT JOIN position ap ON ae.position_id = ap.position_id

                 LEFT JOIN document_attachment df ON dd.doc_id = df.doc_id

        WHERE dd.doc_id = #{docId}
    </select>

    <!-- 2) resultMap Ïóê attachmentKeys ÏôÄ contentDto.refFile Ï∂îÍ∞Ä -->
<!--    <resultMap id="DraftDetailResultMap"-->
<!--               type="com.ddis.ddis_hr.eapproval.query.dto.DraftDetailResponseQueryDTO">-->

        <!-- Í∏∞Î≥∏ ÌïÑÎìú Îß§Ìïë -->
<!--        <id     property="docId"      column="doc_id"/>-->
<!--        <result property="docTitle"   column="doc_title"/>-->
<!--        <result property="team"       column="team"/>-->
<!--        <result property="position"   column="position"/>-->
<!--        <result property="drafter"    column="drafter"/>-->
<!--        <result property="date"       column="date"/>-->
<!--        <result property="docContent" column="doc_content"/>-->
<!--        <result property="keepYear"   column="keep_year"/>-->
<!--        <result property="submitDate" column="submitted_date"/>-->
<!--        <result property="rankId" column="drafterRankId" />-->
<!--        <result property="rankName" column="drafterRankName" />-->
<!--        <result property="role" column="documentBoxRole" />-->
<!--        <association property="contentDto"-->
<!--                     javaType="com.ddis.ddis_hr.eapproval.query.dto.ContentQueryDTO">-->
            <!-- Ï†úÎ™©, receiver, reference, body Îì± Îã§Î•∏ ÌïÑÎìúÍ∞Ä ÏûàÏúºÎ©¥ Ïó¨Í∏∞Ïóê Îß§ÌïëÌï¥ Ï£ºÏÑ∏Ïöî -->
<!--            <result property="title" column="doc_title"/>-->
<!--            <result property="body" column="doc_content"/>-->

<!--            <collection property="refFile"-->
<!--                        ofType="com.ddis.ddis_hr.eapproval.query.dto.FileQueryDTO">-->
<!--                <result property="key"  column="file_url"/>-->
<!--                <result property="name" column="file_name"/>-->
<!--                <result property="size" column="file_size"/>-->
<!--                <result property="type" column="file_type"/>-->
<!--            </collection>-->
            <!-- ÏàòÏã†Ïûê¬∑Ï∞∏Ï°∞Ïûê Î¶¨Ïä§Ìä∏ÎèÑ contentDto Ïóê ÏûàÎã§Î©¥ ÏïÑÎûòÏ≤òÎüº Îß§Ìïë -->
    <!-- Í≤∞Ïû¨ Ïù¥Î†• ÏÇ≠Ï†ú ÌõÑ ÌöåÏàò Ï≤òÎ¶¨ -->


            <!-- Î≥∏Î¨∏(body) Îß§Ìïë -->
<!--        </association>-->

        <!-- attachmentKeys : S3 Key Ïª¨Î†âÏÖòÏúºÎ°úÎßå ÎΩëÏïÑÎÇº Îïå -->

        <!-- contentDto.refFile : FileQueryDTO (name/size/type) Îß§Ìïë -->


<!--    </resultMap>-->
    <select id="countFirstApproverAction" parameterType="long" resultType="int">
        <!-- 1Ï∞® Í≤∞Ïû¨Ïûê(step=2)Í∞Ä Ïù¥ÎØ∏ Í≤∞Ïû¨(status IS NOT NULL)ÌñàÎäîÏßÄ ÌôïÏù∏ -->
        SELECT COUNT(*)
        FROM approval_line
        WHERE doc_id = #{docId}
        AND step   = 2
        AND status IS NOT NULL
    </select>

    <!-- document_boxÏóêÏÑú Í∏∞ÏïàÏûê Ï†úÏô∏Ìïú Í≤∞Ïû¨Ïûê¬∑ÌòëÏ°∞Ïûê ÏóîÌä∏Î¶¨ ÏÇ≠Ï†ú Î∞è draft_documents ÏÉÅÌÉú Î≥ÄÍ≤Ω -->
        <update id="updateDocumentStatusToRecalled" parameterType="long">
            UPDATE draft_documents
            SET doc_status = 'ÌöåÏàò'
            WHERE doc_id = #{docId}
        </update>
</mapper>

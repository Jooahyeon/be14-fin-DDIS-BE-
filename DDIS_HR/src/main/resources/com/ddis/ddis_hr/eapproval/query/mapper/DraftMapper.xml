<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">


<mapper namespace="com.ddis.ddis_hr.eapproval.query.mapper.DraftMapper">

    <!-- 1) 첨부파일 컬럼(file_url, file_name, file_size, file_type)도 함께 조회 -->
    <select id="selectDraftDetail" resultMap="DraftDetailResultMap">
        SELECT
            dd.doc_id,
            dd.doc_title,
            dd.doc_content        AS doc_content,
            dd.preserve_period    AS keep_year,
            dd.created_at         AS date,
      e.employee_name       AS drafter,
      t.team_name           AS team,
      p.position_name       AS position,

      al.approval_line_id   AS approvalLine_id,
      al.step               AS step,
      al.employee_id        AS employee_id,
      ae.employee_name      AS approvalLine_name,
      at.team_name          AS approvalLine_team,
      ap.position_name      AS approvalLine_position,
      al.status             AS approvalLine_status,
      al.type               AS approvalLine_type,
      al.approved_at        AS approvalLine_approveDate,
      al.opinion            AS approvalLine_comment,
      dd.submitted_at       AS submitted_date,

      df.file_url           AS file_url,
      df.file_name          AS file_name,
      df.file_size          AS file_size,
      df.file_type          AS file_type

        FROM draft_documents dd
            LEFT JOIN employee e            ON dd.employee_id     = e.employee_id
            LEFT JOIN team t                ON e.team_id          = t.team_id
            LEFT JOIN position p            ON e.position_id      = p.position_id

            LEFT JOIN approval_line al      ON dd.doc_id         = al.doc_id
            LEFT JOIN employee ae           ON al.employee_id     = ae.employee_id
            LEFT JOIN team at               ON ae.team_id         = at.team_id
            LEFT JOIN position ap           ON ae.position_id     = ap.position_id

            LEFT JOIN document_attachment df ON dd.doc_id         = df.doc_id

        WHERE dd.doc_id = #{docId}
    </select>

    <!-- 2) resultMap 에 attachmentKeys 와 contentDto.refFile 추가 -->
    <resultMap id="DraftDetailResultMap"
               type="com.ddis.ddis_hr.eapproval.query.dto.DraftDetailResponseQueryDTO">

        <!-- 기본 필드 매핑 -->
        <id     property="docId"      column="doc_id"/>
        <result property="docTitle"   column="doc_title"/>
        <result property="team"       column="team"/>
        <result property="position"   column="position"/>
        <result property="drafter"    column="drafter"/>
        <result property="date"       column="date"/>
        <result property="docContent" column="doc_content"/>
        <result property="keepYear"   column="keep_year"/>
        <result property="submitDate" column="submitted_date"/>
        <association property="contentDto"
                     javaType="com.ddis.ddis_hr.eapproval.query.dto.ContentQueryDTO">
            <!-- 제목, receiver, reference, body 등 다른 필드가 있으면 여기에 매핑해 주세요 -->
            <result property="title" column="doc_title"/>
            <result property="body" column="doc_content"/>

            <collection property="refFile"
                        ofType="com.ddis.ddis_hr.eapproval.query.dto.FileQueryDTO">
                <result property="key"  column="file_url"/>
                <result property="name" column="file_name"/>
                <result property="size" column="file_size"/>
                <result property="type" column="file_type"/>
            </collection>
            <!-- 수신자·참조자 리스트도 contentDto 에 있다면 아래처럼 매핑 -->

            <!-- 본문(body) 매핑 -->
        </association>

        <!-- 결재라인 매핑 (기존) -->
        <collection property="approvalLine"
                    ofType="com.ddis.ddis_hr.eapproval.query.dto.ApprovalLineQueryDTO">
            <id     property="id"          column="approvalLine_id"/>
            <result property="step"        column="step"/>
            <result property="employeeId"  column="employee_id"/>
            <result property="name"        column="approvalLine_name"/>
            <result property="team"        column="approvalLine_team"/>
            <result property="position"    column="approvalLine_position"/>
            <result property="status"      column="approvalLine_status"/>
            <result property="type"        column="approvalLine_type"/>
            <result property="approveDate" column="approvalLine_approveDate"/>
            <result property="comment"     column="approvalLine_comment"/>
        </collection>

        <!-- attachmentKeys : S3 Key 컬렉션으로만 뽑아낼 때 -->

        <!-- contentDto.refFile : FileQueryDTO (name/size/type) 매핑 -->


    </resultMap>

</mapper>

